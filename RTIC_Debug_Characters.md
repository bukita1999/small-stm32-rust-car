# RTIC 任务调试字符说明

本文档说明了通过 USART1 (115200 baud, PA9=TX, PA10=RX) 输出的调试字符与对应的 RTIC 任务。

## 调试字符映射表

| 字符 | 任务名称 | 优先级 | 触发频率 | 说明 |
|------|----------|--------|----------|------|
| **S** | `init` | - | 启动时1次 | 系统初始化完成 |
| **0** | `enc0_isr` | 7 | 编码器事件 | 编码器0 (TIM1) 中断服务程序 |
| **1** | `enc1_isr` | 7 | 编码器事件 | 编码器1 (TIM2) 中断服务程序 |
| **2** | `enc2_isr` | 7 | 编码器事件 | 编码器2 (TIM3) 中断服务程序 |
| **3** | `enc3_isr` | 7 | 编码器事件 | 编码器3 (TIM4) 中断服务程序 |
| **P** | `pid_loop` | 6 | 100 Hz | PID 主控制循环 |
| **W** | `pwm_flush` | 5 | ~100 Hz | PWM 输出更新 (PCA9685) |
| **U** | `usb_rx_isr` | 5 | USB数据到达 | USB 接收中断处理 |
| **C** | `cmd_parser` | 4 | ≤20 Hz | 命令解析任务 |
| **T** | `telemetry_tx` | 3 | 2 Hz | 遥测数据发送 |
| **D** | `watchdog_task` | 2 | 10 Hz | 看门狗安全检查 |
| **H** | `led_heartbeat` | 1 | 2 Hz | LED 心跳指示 |

## 正常运行时的输出模式

### 启动阶段
```
S       # 系统初始化完成
```

### 正常运行时 (无编码器输入)
```
PHDT PHDT PHDT ...
- P: PID循环 (100Hz)
- H: LED心跳 (2Hz) 
- D: 看门狗 (10Hz)
- T: 遥测 (2Hz)
```

### 有编码器输入时
```
P0123WDT P0123WDT ...
- 0123: 四路编码器中断 (根据实际转动情况)
- W: PWM输出更新 (跟随PID循环)
```

### 有USB通信时
```
UPWDTC UPWDTC ...
- U: USB接收中断
- C: 命令解析
```

## 测试验证方法

### 1. 基本功能测试
连接串口工具 (115200, 8N1) 到 PA9，应该看到：
- 启动时出现 `S`
- 每秒出现 2 次 `H` (LED心跳)
- 每 100ms 出现 `P` (PID循环)
- 每 100ms 出现 `D` (看门狗)
- 每 500ms 出现 `T` (遥测)

### 2. 实时性验证
- `P` 字符应该严格按 10ms 间隔出现
- `H` 和 `T` 应该每 500ms 同时出现
- `D` 应该每 100ms 出现 (与P交错)

### 3. 中断响应测试
- 手动转动编码器，应该看到相应的数字字符 `0`, `1`, `2`, `3`
- USB连接后发送数据，应该看到 `U` 和 `C` 字符

### 4. 优先级验证
当多个任务同时触发时，字符出现顺序应该按优先级排列：
1. 编码器字符 (0-3) 最先出现
2. PID循环 (P) 次之
3. 其他任务按优先级顺序

## 故障诊断

### 无任何输出
- 检查 USART1 引脚连接 (PA9)
- 检查波特率设置 (115200)
- 检查系统时钟配置

### 缺少某些字符
- `S` 缺失: 初始化失败
- `H` 缺失: LED任务未启动或崩溃
- `P` 缺失: 主控制循环故障，系统无法正常工作
- `0-3` 缺失: 编码器定时器未配置或无输入信号

### 字符频率异常
- `P` 频率不对: 系统时钟或SysTick配置问题
- `H` 频率不对: 任务调度问题
- 字符重叠: 可能存在死锁或优先级倒置

## 开发建议

1. **初始测试**: 先确保看到基本的 `SPHT` 字符循环
2. **渐进测试**: 逐步启用各个硬件模块，观察字符变化
3. **性能分析**: 通过字符密度分析系统负载
4. **实时监控**: 生产环境可关闭调试输出以节省性能

---

*此调试功能仅用于开发和测试阶段，生产版本应禁用串口输出。*