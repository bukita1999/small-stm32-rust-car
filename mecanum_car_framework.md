# 麦克纳姆轮小车 RTIC 框架开发说明

## 项目概述

本项目基于 STM32F103C8T6 微控制器，使用 Rust RTIC 实时操作系统框架开发四轮麦克纳姆轮小车控制系统。采用分层任务调度和优先级管理，实现 100Hz 主控制循环的高精度运动控制。

## 系统架构

### 硬件配置
- **主控**: STM32F103C8T6 (72MHz)
- **电机驱动**: 4路 L298N 驱动模块
- **PWM控制**: PCA9685 16路PWM驱动器 (I2C接口)
- **编码器**: 4路正交编码器 (TIM1-TIM4 硬件解码)
- **通信**: USB CDC-ACM 虚拟串口
- **指示**: PC13 LED 心跳指示

### 软件框架特性
- **实时性**: RTIC 2.1 抢占式多任务调度
- **时间精度**: SysTick 单调定时器，微秒级时间戳
- **内存安全**: Rust 零成本抽象，无动态内存分配
- **通信协议**: ASCII 文本协议，支持速度控制和参数调整

## 任务优先级设计

按照实时性要求从高到低排列：

| 优先级 | 任务名称 | 触发方式 | 频率 | 主要职责 |
|--------|----------|----------|------|----------|
| **7** | `enc0_isr` ~ `enc3_isr` | TIM1-4 中断 | 事件触发 | 编码器计数溢出处理，更新位置和时间戳 |
| **6** | `pid_loop` | 定时调度 | 100 Hz | PID控制算法，计算四路电机PWM输出 |
| **5** | `pwm_flush` | 任务派发 | ~100 Hz | I2C批量写入PCA9685，同步更新四路PWM |
| **5** | `usb_rx_isr` | USB中断 | 数据到达 | USB接收缓冲，字节入队到环形缓冲区 |
| **4** | `cmd_parser` | 任务派发 | ≤20 Hz | 协议解析，更新速度设定值和PID参数 |
| **3** | `telemetry_tx` | 定时调度 | 2 Hz | 状态遥测上报，格式化传感器数据 |
| **2** | `watchdog_task` | 定时调度 | 10 Hz | 通信超时检测，30秒无指令自动停车 |
| **1** | `led_heartbeat` | 定时调度 | 2 Hz | 系统状态指示，LED闪烁心跳 |

## 核心数据结构

### 轮子状态 (WheelState)
```rust
struct WheelState {
    position: i32,        // 累积编码器计数
    velocity: f32,        // 当前转速 (单位: 计数/秒)
    last_timestamp: u32,  // 上次更新时间戳
    last_count: u16,      // 上次计数器值
    overflow_count: i16,  // 溢出计数器
}
```

### PID控制器 (PidController)
```rust
struct PidController {
    kp: f32,              // 比例增益
    ki: f32,              // 积分增益  
    kd: f32,              // 微分增益
    integral: f32,        // 积分累积值
    last_error: f32,      // 上次误差
    integral_clamp: f32,  // 积分限幅
}
```

### 通信协议
```
指令格式:
> VEL 120 -120 120 -120\n     # 四轮速度设定 (计数/秒)
> SET_PID 0 1.2 0.1 0.05\n    # 设置0号轮PID参数
> STOP\n                      # 紧急停止

回报格式:  
< STA 118 -119 119 -119 | E:0.5 0.4 0.3 0.2\n  # 状态+误差
```

## 系统常量配置

```rust
const MAIN_LOOP_FREQ_HZ: u32 = 100;           // 主控制频率
const TELEMETRY_FREQ_HZ: u32 = 2;             // 遥测频率
const WATCHDOG_FREQ_HZ: u32 = 10;             // 看门狗检查频率
const WATCHDOG_TIMEOUT_MS: u32 = 30000;       // 30秒超时阈值
const USB_RX_BUFFER_SIZE: usize = 256;        // USB接收缓冲区
const ENCODER_OVERFLOW_THRESHOLD: u16 = 60000; // 编码器溢出阈值
```

## 分阶段开发路径

### 阶段1: 硬件点亮验证
- [ ] LED 心跳指示正常闪烁
- [ ] I2C 通信测试 (PCA9685 地址应答)
- [ ] USB 虚拟串口枚举成功
- [ ] 编码器定时器配置验证

### 阶段2: 编码器数据采集
- [ ] 四路编码器计数读取
- [ ] 溢出处理和位置累积
- [ ] 速度计算算法 (时间差分)
- [ ] 遥测数据上报验证

### 阶段3: PWM输出控制
- [ ] PCA9685 PWM通道配置
- [ ] L298N 方向和使能信号
- [ ] 电机转向和停止测试
- [ ] PWM占空比线性响应

### 阶段4: PID闭环控制
- [ ] PID参数整定 (Ziegler-Nichols方法)
- [ ] 积分限幅和抗饱和
- [ ] 前馈补偿 (可选)
- [ ] 四轮独立速度控制

### 阶段5: 协议和安全机制
- [ ] ASCII协议帧解析
- [ ] 参数在线调整
- [ ] 看门狗超时保护
- [ ] 异常状态恢复

### 阶段6: 系统集成测试
- [ ] 负载运行稳定性
- [ ] 温升和功耗测试
- [ ] 长时间连续运行
- [ ] 上位机联调验证

## 开发工具链

### 编译和烧录
```bash
# 构建项目
cargo build --bin mecanum_car

# 烧录和运行
cargo run --bin mecanum_car

# 发布版本构建
cargo build --bin mecanum_car --release
```

### 调试工具
- **probe-rs**: 实时烧录和调试
- **defmt**: 结构化日志输出到RTT
- **Logic Analyzer**: I2C/编码器信号分析
- **示波器**: PWM波形和编码器AB相验证

## 预期性能指标

- **控制精度**: ±2% 速度跟踪误差
- **响应时间**: <100ms 阶跃响应时间
- **稳定性**: 连续30分钟无异常运行
- **通信延迟**: <10ms USB指令响应时间
- **功耗**: 静态 <200mA，运行 <2A (不含电机)

## 注意事项

1. **内存管理**: 使用 `heapless` 容器，避免动态分配
2. **中断安全**: 共享资源通过 RTIC 锁机制保护
3. **时序要求**: 编码器ISR必须及时处理，避免计数丢失
4. **故障安全**: 看门狗机制确保通信中断时自动停车
5. **调试输出**: 生产版本可关闭 `defmt` 日志以节省Flash空间

---

*本框架代码已完成基础结构搭建，所有TODO标记的函数待后续分阶段实现。*